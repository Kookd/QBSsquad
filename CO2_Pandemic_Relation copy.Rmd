---
title: "Aim2 analysis"
author: "Yuxuan Peng"
date: "2022-11-02"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

First, to examine global CO2 emission in pre-pandemic and pandemic years, a subset of data about 2018, 2019, and 2020 CO2 emission in all countries is created.
```{r}
CO2 <- read.csv("CO2 emission by countries.csv")
head(CO2)
library(dplyr)
library(tidyverse)
pandemic.CO2 <- CO2 %>%
  filter(Year >= 2018, na.rm = TRUE)
head(pandemic.CO2)
```

Then, we want to explore the general trend of changes in CO2 emission in all countries due to the pandemic. Thus, we presented the global cumulative CO2 emission during these three years.
```{r}
cum.2018 <- sum(pandemic.CO2[which(pandemic.CO2$Year=='2018'), 5])
cum.2019 <- sum(pandemic.CO2[which(pandemic.CO2$Year=='2019'), 5])
cum.2020 <- sum(pandemic.CO2[which(pandemic.CO2$Year=='2020'), 5])

barplot(tapply(pandemic.CO2$CO2.emission..Tons., format(pandemic.CO2$Year), FUN=sum), col="#69b3a2")
```

We could see from the graph that there's not much change in global cumulative CO2 emission during the pandemic years. Here we want to separately analyze the top5 emission countries and see if there's any difference.
```{r}
CO2.a <- pandemic.CO2 %>% 
  filter(Year == "2018") %>%
  arrange(desc(CO2.emission..Tons.)) %>%
  slice_head(n = 5)
CO2.a

CO2.b <- pandemic.CO2 %>% 
  filter(Year == "2019") %>%
  arrange(desc(CO2.emission..Tons.)) %>%
  slice_head(n = 5)
CO2.b

CO2.c <- pandemic.CO2 %>% 
  filter(Year == "2020") %>%
  arrange(desc(CO2.emission..Tons.)) %>%
  slice_head(n = 5)
CO2.c
df.top5 = rbind(CO2.a,CO2.b,CO2.c)

# df.top5 <- df.top5 %>%
#   mutate(log.CO2 = log(CO2.emission..Tons.))


# ggplot(data=df.top5, aes(x= Year, y = CO2.emission..Tons.))+
#   geom_bar(stat = "identity", fill="steelblue")+
#   geom_text(aes(label=Country), vjust=1.5, color = "white", size = 3)+
#   scale_fill_brewer(palette = "Dark2")+
#   theme_classic()

ggplot(df.top5, aes(x = Year, y = CO2.emission..Tons., color = Country)) +
  geom_line()
```
As shown in this graph, although the overall CO2 emission in these 5 top emission countries slightly increased during pandemic, there's still not much difference observed. This is not what we've expected before since we expect the emission rate to decrease during the pandemic.

Now we want to join another dataset with information about absolute growth of CO2 and other information about CO2 per capita/gdp/unit energy to explore further on pandemic-CO2 emission relationship.
First, we read our new dataset about owid-co2-data from github and filtered the wanted period.
```{r}
library(httr); library(RCurl)
res = GET("https://github.com/owid/co2-data")

x <- getURL("https://raw.githubusercontent.com/owid/co2-data/master/owid-co2-data.csv")
world.co2 <- read.csv(text = x)
class(world.co2)
world.pandemic <- world.co2 %>%
  filter(year >= 2018, na.rm = TRUE)
```

Then we joined the two datasets based on country names. Here we used SQL to make the join.
```{r}
library(sqldf)
tot.dat <- sqldf("SELECT p.Country, p.year, p.'CO2.emission..Tons.',
w.co2_growth_abs, w.co2_growth_prct, w.co2_per_gdp, w.co2_per_capita
      FROM 'pandemic.CO2' AS p
      JOIN 'world.pandemic' AS w 
      ON p.Country=w.country
      AND p.Year=w.year")
```

Now we wanted to plot the absolute growth of co2 emission during the pandemic in a global perspective. First, let's check if there are any missing values in our interested data.
```{r}
sum(is.na(tot.dat$co2_growth_abs))
which(is.na(tot.dat$co2_growth_abs))
```
NAs are located at Antarctica, Christmas Island, and Puerto Rico. We noticed that there might be no data available for those countries so we just denoted them as 0.
```{r}
tot.dat$co2_growth_abs[is.na(tot.dat$co2_growth_abs)] = 0
#check again
sum(is.na(tot.dat$co2_growth_abs))
```

Now we can visualize our results regarding absolute growth of CO2 emission.
```{r}

```




